<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Master - Multi User</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* === 1. GLOBAL STYLES & ANIMATIONS === */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --accent: #fbc531;
            --bg-color: #f0f2f5;
            --text-dark: #2d3436;
            --success: #00b894;
            --danger: #d63031;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body { 
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            height: 100vh; overflow: hidden; 
        }

        /* Moving Background Animation */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating Animation for Cards */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* Money Rain Animation */
        @keyframes fall {
            0% { top: -50px; opacity: 1; transform: rotate(0deg); }
            100% { top: 100vh; opacity: 0; transform: rotate(360deg); }
        }
        .money { position: fixed; z-index: 9999; font-size: 24px; pointer-events: none; }

        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .center { justify-content: center; }
        
        /* === 2. LOGIN & REGISTER SCREEN === */
        .auth-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); z-index: 1000;
        }
        
        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px; border-radius: 20px; width: 400px; text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            animation: float 6s ease-in-out infinite;
        }

        .auth-card h2 { color: var(--primary); margin-bottom: 10px; }
        .auth-card p { color: #666; margin-bottom: 20px; font-size: 0.9rem; }
        
        .input-box {
            position: relative; margin-bottom: 15px;
            border: 2px solid #ddd; border-radius: 10px; background: #fff;
            transition: 0.3s;
        }
        .input-box:focus-within { border-color: var(--primary); }
        .input-box i { position: absolute; left: 15px; top: 12px; color: #888; }
        .input-box input {
            width: 100%; padding: 10px 10px 10px 45px; border: none; outline: none; background: transparent;
        }

        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .btn-primary { background: linear-gradient(to right, #4e54c8, #8f94fb); color: white; }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(78, 84, 200, 0.4); }
        
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); margin-top: 10px; }
        .btn-outline:hover { background: var(--primary); color: white; }

        /* === 3. DASHBOARD LAYOUT === */
        .dashboard-container {
            display: flex; height: 100vh; width: 100%; background: #f4f7f6;
        }

        /* Sidebar */
        .sidebar {
            width: 250px; background: #2d3436; color: white;
            display: flex; flex-direction: column; padding: 20px;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }
        .logo { font-size: 1.5rem; font-weight: bold; margin-bottom: 40px; text-align: center; color: var(--accent); }
        .nav-item {
            padding: 15px; color: #b2bec3; cursor: pointer; transition: 0.3s; border-radius: 10px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;
        }
        .nav-item:hover, .nav-item.active { background: var(--primary); color: white; transform: translateX(5px); }
        
        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .welcome-text h1 { font-size: 1.8rem; color: #2d3436; }
        
        /* Grid Layout */
        .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } .sidebar { display: none; } }

        /* Cards */
        .card {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 20px;
            transition: 0.3s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        
        /* Net Worth Card */
        .balance-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .balance-card h3 { opacity: 0.8; font-size: 0.9rem; }
        .balance-card h1 { font-size: 2.5rem; margin: 10px 0; }
        
        /* Form Styling */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        
        .tab-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; text-align: center; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { font-size: 0.85rem; color: #888; text-transform: uppercase; }
        .amount-pos { color: var(--success); font-weight: bold; }
        .amount-neg { color: var(--danger); font-weight: bold; }

        /* Gamification */
        .progress-bar { background: #eee; height: 20px; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 1s; }
        
        /* Report PDF Style */
        .report-view { background: white; padding: 40px; min-height: 800px; display: none; }
        .report-view.visible { display: block; }
        @media print {
            body * { visibility: hidden; }
            .report-view, .report-view * { visibility: visible; }
            .report-view { position: absolute; left: 0; top: 0; width: 100%; }
        }

    </style>
</head>
<body>

    <div id="authScreen" class="auth-wrapper">
        <div id="loginCard" class="auth-card">
            <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;">
                <i class="fas fa-wallet"></i>
            </div>
            <h2>Finance Master</h2>
            <p>Sign in to manage your personal finances.</p>
            
            <form id="loginForm">
                <div class="input-box">
                    <i class="fas fa-user"></i>
                    <input type="text" id="loginUser" placeholder="Username" required>
                </div>
                <div class="input-box">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="loginPass" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary">Secure Login</button>
            </form>
            <button class="btn btn-outline" onclick="app.toggleAuth('register')">Create New Account</button>
        </div>

        <div id="registerCard" class="auth-card hidden">
            <div style="font-size: 3rem; color: var(--success); margin-bottom: 10px;">
                <i class="fas fa-user-plus"></i>
            </div>
            <h2>Join Us</h2>
            <p>Create a secure account to track data separately.</p>
            
            <form id="registerForm">
                <div class="input-box">
                    <i class="fas fa-user"></i>
                    <input type="text" id="regUser" placeholder="Choose Username" required>
                </div>
                <div class="input-box">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="regPass" placeholder="Choose Password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="background: var(--success);">Register Now</button>
            </form>
            <button class="btn btn-outline" onclick="app.toggleAuth('login')">Back to Login</button>
        </div>
    </div>


    <div id="dashboardScreen" class="dashboard-container hidden">
        <div class="sidebar">
            <div class="logo"><i class="fas fa-chart-pie"></i> FIN.MASTER</div>
            <div class="nav-item active" onclick="app.nav('home')"><i class="fas fa-home"></i> Dashboard</div>
            <div class="nav-item" onclick="app.nav('transactions')"><i class="fas fa-list"></i> History</div>
            <div class="nav-item" onclick="app.nav('account')"><i class="fas fa-user"></i> Account</div>
            <div class="nav-item" onclick="app.nav('report')"><i class="fas fa-file-pdf"></i> Report</div>
            <div style="margin-top: auto;"></div>
            <div class="nav-item" onclick="app.logout()" style="color: #ff7675;"><i class="fas fa-sign-out-alt"></i> Logout</div>
        </div>

        <div class="main-content">
            
            <div id="view-home">
                <div class="header">
                    <div class="welcome-text">
                        <h1>Hello, <span id="displayUser">User</span>! üëã</h1>
                        <p>Here is your financial overview.</p>
                    </div>
                    <div style="font-size: 2rem; color: var(--accent); display:none;" id="proBadge">
                        <i class="fas fa-crown" title="Pro User"></i>
                    </div>
                </div>

                <div class="grid">
                    <div class="left-col">
                        <div class="card balance-card">
                            <h3>Total Net Worth</h3>
                            <h1 id="totalBalance">$0.00</h1>
                            <div class="flex" style="justify-content: space-between; margin-top: 20px;">
                                <div><i class="fas fa-arrow-down"></i> Inc: <span id="totalInc">$0</span></div>
                                <div><i class="fas fa-arrow-up"></i> Exp: <span id="totalExp">$0</span></div>
                            </div>
                        </div>

                        <div class="card" style="border-top: 4px solid var(--accent);">
                            <div class="flex" style="justify-content: space-between;">
                                <h4>üèÜ Pro Challenge</h4>
                                <button onclick="app.triggerRain()" style="font-size:0.7rem; cursor:pointer;">(Test Anim)</button>
                            </div>
                            <p style="font-size: 0.8rem; color:#666; margin-top: 5px;">Goal: Reach <strong>$2,000</strong> Net Worth</p>
                            <div class="progress-bar">
                                <div id="progressBar" class="progress-fill"></div>
                            </div>
                            <div id="rewardMsg" class="hidden" style="text-align:center; margin-top:10px; color: goldenrod; font-weight:bold;">
                                <i class="fas fa-medal"></i> Goal Reached!
                            </div>
                        </div>

                        <div class="card">
                            <h4>Expense Breakdown</h4>
                            <canvas id="expenseChart" style="max-height: 200px;"></canvas>
                        </div>
                    </div>

                    <div class="right-col">
                        <div class="card">
                            <h4>New Transaction</h4>
                            <br>
                            <form id="addForm">
                                <div class="tab-group">
                                    <div class="tab active" id="tabExp" onclick="app.setTab('expense')">Expense</div>
                                    <div class="tab" id="tabInc" onclick="app.setTab('income')">Income</div>
                                </div>
                                <input type="hidden" id="type" value="expense">
                                
                                <div class="form-group">
                                    <input type="text" id="desc" class="form-control" placeholder="Description (e.g. Lunch)" required>
                                </div>
                                <div class="form-group">
                                    <input type="number" id="amount" class="form-control" placeholder="Amount ($)" required>
                                </div>
                                <div class="form-group">
                                    <select id="category" class="form-control">
                                        <option value="Food">üçî Food</option>
                                        <option value="Transport">üöó Transport</option>
                                        <option value="Shopping">üõçÔ∏è Shopping</option>
                                        <option value="Bills">üìÉ Bills</option>
                                        <option value="Salary">üí∞ Salary</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Transaction</button>
                            </form>
                        </div>

                        <div class="card">
                            <h4>Recent Activity</h4>
                            <div class="table-container">
                                <table>
                                    <thead><tr><th>Desc</th><th>Cat</th><th>Amount</th><th></th></tr></thead>
                                    <tbody id="recentTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-transactions" class="hidden">
                <div class="card">
                    <h2>Transaction History</h2>
                    <button class="btn btn-outline" style="width:100px; padding:5px;" onclick="app.nav('home')">Back</button>
                    <table>
                        <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Type</th><th>Amount</th><th>Action</th></tr></thead>
                        <tbody id="fullTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-account" class="hidden">
                <div class="card" style="max-width: 500px; margin: 0 auto;">
                    <h2>Edit Profile</h2>
                    <form id="profileForm">
                        <div class="form-group">
                            <label>Current Username</label>
                            <input type="text" id="profUser" class="form-control" disabled>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="profPass" class="form-control" placeholder="New Password">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Profile</button>
                    </form>
                </div>
            </div>

            <div id="view-report" class="report-view">
                <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px;">
                    <h1>Financial Statement</h1>
                    <p>Generated for: <span id="repUser"></span></p>
                    <p>Date: <span id="repDate"></span></p>
                </div>
                <br>
                <table>
                    <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th></tr></thead>
                    <tbody id="repTable"></tbody>
                </table>
                <br>
                <h2 style="text-align: right;">Net Worth: <span id="repTotal"></span></h2>
                <br><br>
                <div style="text-align: center;">
                    <button class="btn btn-primary" style="width: 200px;" onclick="window.print()">Print / Save PDF</button>
                    <br><br>
                    <button class="btn btn-outline" style="width: 200px;" onclick="app.nav('home')">Back to Dashboard</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        class App {
            constructor() {
                // Load data specific to current user
                this.users = JSON.parse(localStorage.getItem('fm_users')) || [];
                this.currentUser = JSON.parse(sessionStorage.getItem('fm_current'));
                this.transactions = JSON.parse(localStorage.getItem('fm_data')) || [];
                this.chart = null;

                this.init();
            }

            init() {
                if (this.currentUser) {
                    this.loadDashboard();
                } else {
                    this.showAuth();
                }

                // Event Listeners
                document.getElementById('loginForm').addEventListener('submit', e => { e.preventDefault(); this.login(); });
                document.getElementById('registerForm').addEventListener('submit', e => { e.preventDefault(); this.register(); });
                document.getElementById('addForm').addEventListener('submit', e => { e.preventDefault(); this.addTx(); });
                document.getElementById('profileForm').addEventListener('submit', e => { e.preventDefault(); this.updateProfile(); });
            }

            // === AUTH SYSTEM ===
            toggleAuth(view) {
                if(view === 'register') {
                    document.getElementById('loginCard').classList.add('hidden');
                    document.getElementById('registerCard').classList.remove('hidden');
                } else {
                    document.getElementById('registerCard').classList.add('hidden');
                    document.getElementById('loginCard').classList.remove('hidden');
                }
            }

            register() {
                const u = document.getElementById('regUser').value;
                const p = document.getElementById('regPass').value;
                
                if (this.users.find(user => user.username === u)) {
                    alert('Username already exists!');
                    return;
                }

                this.users.push({ username: u, password: p });
                localStorage.setItem('fm_users', JSON.stringify(this.users));
                alert('Account Created! Please Login.');
                this.toggleAuth('login');
            }

            login() {
                const u = document.getElementById('loginUser').value;
                const p = document.getElementById('loginPass').value;
                
                const user = this.users.find(user => user.username === u && user.password === p);
                
                if (user) {
                    this.currentUser = user;
                    sessionStorage.setItem('fm_current', JSON.stringify(user));
                    this.loadDashboard();
                } else {
                    alert('Invalid Credentials');
                }
            }

            logout() {
                sessionStorage.removeItem('fm_current');
                location.reload();
            }

            showAuth() {
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('dashboardScreen').classList.add('hidden');
            }

            loadDashboard() {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('dashboardScreen').classList.remove('hidden');
                document.getElementById('displayUser').innerText = this.currentUser.username;
                this.renderData();
            }

            // === DATA HANDLING ===
            addTx() {
                const desc = document.getElementById('desc').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const type = document.getElementById('type').value;
                const cat = document.getElementById('category').value;

                const tx = {
                    id: Date.now(),
                    user: this.currentUser.username, // LINK DATA TO USER
                    desc, amount, type, cat,
                    date: new Date().toLocaleDateString()
                };

                this.transactions.unshift(tx);
                localStorage.setItem('fm_data', JSON.stringify(this.transactions));
                
                document.getElementById('addForm').reset();
                this.renderData();
            }

            deleteTx(id) {
                if(confirm('Delete this item?')) {
                    this.transactions = this.transactions.filter(t => t.id !== id);
                    localStorage.setItem('fm_data', JSON.stringify(this.transactions));
                    this.renderData();
                }
            }

            renderData() {
                // FILTER DATA BY USERNAME
                const myData = this.transactions.filter(t => t.user === this.currentUser.username);
                
                let income = 0, expense = 0, catMap = {};
                const recentTbody = document.getElementById('recentTable');
                const fullTbody = document.getElementById('fullTable');
                const repTbody = document.getElementById('repTable');

                recentTbody.innerHTML = ''; fullTbody.innerHTML = ''; repTbody.innerHTML = '';

                myData.forEach(t => {
                    if (t.type === 'income') income += t.amount;
                    else {
                        expense += t.amount;
                        catMap[t.cat] = (catMap[t.cat] || 0) + t.amount;
                    }

                    // Render Rows
                    const cls = t.type === 'income' ? 'amount-pos' : 'amount-neg';
                    const sign = t.type === 'income' ? '+' : '-';
                    
                    // Recent
                    if(recentTbody.children.length < 5) {
                        recentTbody.innerHTML += `<tr><td>${t.desc}</td><td>${t.cat}</td><td class="${cls}">${sign}$${t.amount}</td><td><i class="fas fa-trash" style="cursor:pointer; color:#ff7675;" onclick="app.deleteTx(${t.id})"></i></td></tr>`;
                    }
                    
                    // Full & Report
                    const fullRow = `<tr><td>${t.date}</td><td>${t.cat}</td><td>${t.desc}</td><td>${t.type}</td><td class="${cls}">${sign}$${t.amount}</td><td><i class="fas fa-trash" onclick="app.deleteTx(${t.id})"></i></td></tr>`;
                    fullTbody.innerHTML += fullRow;
                    repTbody.innerHTML += `<tr><td>${t.date}</td><td>${t.cat}</td><td>${t.desc}</td><td class="${cls}">${sign}$${t.amount}</td></tr>`;
                });

                const netWorth = income - expense;
                document.getElementById('totalBalance').innerText = `$${netWorth.toLocaleString()}`;
                document.getElementById('totalInc').innerText = `$${income}`;
                document.getElementById('totalExp').innerText = `$${expense}`;

                this.updateChart(catMap);
                this.checkGoal(netWorth);
                this.prepareReport(netWorth);
            }

            // === CHART & ANIMATION ===
            updateChart(data) {
                const ctx = document.getElementById('expenseChart').getContext('2d');
                if (this.chart) this.chart.destroy();
                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{ data: Object.values(data), backgroundColor: ['#ff7675', '#fdcb6e', '#00b894', '#0984e3', '#6c5ce7'] }]
                    }
                });
            }

            checkGoal(netWorth) {
                const goal = 2000;
                let pct = Math.min((netWorth / goal) * 100, 100);
                if (pct < 0) pct = 0;
                
                document.getElementById('progressBar').style.width = pct + '%';

                if (netWorth >= goal) {
                    document.getElementById('rewardMsg').classList.remove('hidden');
                    document.getElementById('proBadge').style.display = 'block';
                    // Trigger Rain only once per session or load
                    if (!this.rainTriggered) {
                        this.triggerRain();
                        this.rainTriggered = true;
                    }
                }
            }

            triggerRain() {
                for (let i = 0; i < 30; i++) {
                    let m = document.createElement('div');
                    m.innerHTML = ['üí∏','üí∞','üíµ','üíé'][Math.floor(Math.random()*4)];
                    m.className = 'money';
                    m.style.left = Math.random() * 100 + 'vw';
                    m.style.animation = `fall ${Math.random()*2+2}s linear`;
                    document.body.appendChild(m);
                    setTimeout(() => m.remove(), 4000);
                }
            }

            // === NAVIGATION & UTILS ===
            nav(view) {
                // Hide all views
                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-transactions').classList.add('hidden');
                document.getElementById('view-account').classList.add('hidden');
                document.getElementById('view-report').classList.remove('visible'); // special for print

                if (view === 'home') document.getElementById('view-home').classList.remove('hidden');
                if (view === 'transactions') document.getElementById('view-transactions').classList.remove('hidden');
                if (view === 'account') {
                    document.getElementById('view-account').classList.remove('hidden');
                    document.getElementById('profUser').value = this.currentUser.username;
                }
                if (view === 'report') document.getElementById('view-report').classList.add('visible');
            }

            setTab(type) {
                document.getElementById('type').value = type;
                document.getElementById('tabExp').className = type === 'expense' ? 'tab active' : 'tab';
                document.getElementById('tabInc').className = type === 'income' ? 'tab active' : 'tab';
            }

            updateProfile() {
                const newPass = document.getElementById('profPass').value;
                if(newPass) {
                    // Find user index
                    const idx = this.users.findIndex(u => u.username === this.currentUser.username);
                    this.users[idx].password = newPass;
                    localStorage.setItem('fm_users', JSON.stringify(this.users));
                    alert('Password Updated!');
                }
            }
            
            prepareReport(total) {
                document.getElementById('repUser').innerText = this.currentUser.username;
                document.getElementById('repDate').innerText = new Date().toLocaleDateString();
                document.getElementById('repTotal').innerText = `$${total.toLocaleString()}`;
            }
        }

        const app = new App();
    </script>
</body>
</html>
